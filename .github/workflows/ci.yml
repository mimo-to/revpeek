name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  test:
    runs-on: ubuntu-latest 
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Create lib directory and download picocli
      run: |
        mkdir -p lib
        # Download picocli JAR
        wget -O lib/picocli-4.7.5.jar https://repo1.maven.org/maven2/info/picocli/picocli/4.7.5/picocli-4.7.5.jar
        # Create src/main/java if it doesn't exist
        mkdir -p src/main/java
    
    - name: Build with build.ps1 (using PowerShell on Windows runner)
      run: |
        # Since we're on Ubuntu, we'll use a different approach
        # Compile Java files
        javac -d build -cp "lib/*" $(find src/main/java -name "*.java")
      shell: pwsh
    
    - name: Run tests
      run: |
        echo "Running tests..."
        # Placeholder for actual tests
        # java -cp "build:lib/*" org.junit.runner.JUnitCore TestSuite

  build:
    runs-on: ${{ matrix.os }}
    needs: test
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Create lib directory and download picocli
      run: |
        mkdir -p lib
        # Download picocli JAR
        if [ "$RUNNER_OS" == "Windows" ]; then
          curl -L -o lib/picocli-4.7.5.jar https://repo1.maven.org/maven2/info/picocli/picocli/4.7.5/picocli-4.7.5.jar
        else
          wget -O lib/picocli-4.7.5.jar https://repo1.maven.org/maven2/info/picocli/picocli/4.7.5/picocli-4.7.5.jar
        fi
      shell: bash
    
    - name: Build JAR (Unix)
      if: runner.os != 'Windows'
      run: |
        # Compile Java files
        mkdir -p build
        javac -d build -cp "lib/*" $(find src/main/java -name "*.java")
        
        # Create manifest
        echo "Main-Class: com.revpeek.cli.RevPeekCommand" > build/manifest.txt
        
        # Create JAR
        jar -c -m build/manifest.txt -f build/revpeek.jar -C build .
        
        # Embed picocli classes into the JAR
        jar -uf build/revpeek.jar -C lib .
      shell: bash
    
    - name: Build JAR (Windows)
      if: runner.os == 'Windows'
      run: |
        # Compile Java files
        if (!(Test-Path "build")) { New-Item -ItemType Directory -Path "build" | Out-Null }
        javac -d build -cp "lib/*" $(Get-ChildItem -Path "src/main/java" -Recurse -Filter "*.java" | ForEach-Object { $_.FullName })
        
        # Create manifest
        "Main-Class: com.revpeek.cli.RevPeekCommand" | Out-File -FilePath "build\manifest.txt" -Encoding ASCII
        
        # Create JAR
        jar -c -m build\manifest.txt -f build\revpeek.jar -C build .
        
        # Extract picocli and embed into JAR
        $picocliJar = "lib\picocli-4.7.5.jar"
        if (Test-Path $picocliJar) {
          # Extract picocli classes to a temp directory
          $tempDir = "temp_picocli"
          if (Test-Path $tempDir) { Remove-Item -Path $tempDir -Recurse -Force }
          New-Item -ItemType Directory -Path $tempDir | Out-Null
          Expand-Archive -Path $picocliJar -DestinationPath $tempDir
          
          # Remove META-INF to avoid manifest conflicts
          if (Test-Path "$tempDir\META-INF") { Remove-Item -Path "$tempDir\META-INF" -Recurse -Force }

          # Add picocli classes to the main JAR
          Push-Location $tempDir
          jar -uf ..\build\revpeek.jar .
          Pop-Location
          
          # Clean up
          Remove-Item -Path $tempDir -Recurse -Force
        }
      shell: pwsh
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: revpeek-jar-${{ matrix.os }}
        path: build/revpeek.jar

  release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release' && github.event.action == 'published'
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: revpeek-jar-ubuntu-latest
        path: assets
    
    - name: Upload to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: assets/revpeek.jar
        asset_name: revpeek.jar
        asset_content_type: application/java-archive